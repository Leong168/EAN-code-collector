<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR & Barcode Scanner</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
    <!-- ZXing Library for barcode scanning -->
    <script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>
    <!-- SheetJS (XLSX) for Excel export -->
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Container -->
    <div id="app-container" class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-10 w-full max-w-4xl flex flex-col items-center space-y-8">
        <h1 class="text-4xl md:text-5xl font-extrabold text-blue-600 dark:text-blue-400">Inventory Scanner</h1>
        <p class="text-lg text-center text-gray-600 dark:text-gray-300 max-w-lg">
            Scan QR codes for item information and Code 128 barcodes for numbering.
        </p>

        <!-- UI for Scanning -->
        <div class="w-full flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-8">
            <div class="w-full md:w-1/2 flex flex-col items-center">
                <video id="video-feed" class="w-full max-w-md h-auto rounded-xl shadow-lg border-2 border-gray-300 dark:border-gray-600 aspect-video"></video>
                <div class="mt-4 w-full text-center">
                    <p id="scan-message" class="text-lg font-semibold text-gray-700 dark:text-gray-200">
                        Initializing scanner...
                    </p>
                    <div id="loading-spinner" class="mt-2 text-center text-blue-500 hidden">
                        <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                </div>
                <button id="scan-button" class="mt-4 px-6 py-3 bg-blue-600 text-white font-bold rounded-full shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50" disabled>
                    Start Scanning
                </button>
            </div>

            <!-- Display for Scanned Data -->
            <div class="w-full md:w-1/2 mt-8 md:mt-0">
                <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6 shadow-inner w-full h-80 overflow-y-auto">
                    <h2 class="text-xl font-bold mb-4 border-b-2 border-gray-300 dark:border-gray-600 pb-2">Scanned Items</h2>
                    <ul id="scanned-list" class="space-y-4">
                        <li class="text-gray-500 dark:text-gray-400">No items scanned yet.</li>
                    </ul>
                </div>
                <button id="export-button" class="mt-6 px-6 py-3 w-full bg-green-600 text-white font-bold rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50" disabled>
                    Export to Excel
                </button>
            </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-sm text-center transform scale-95 md:scale-100 transition-all duration-300 ease-out">
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="modal-body" class="text-gray-700 dark:text-gray-200"></p>
            <button id="modal-close-button" class="mt-6 px-6 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition duration-300">Close</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI Element References ---
            const videoElement = document.getElementById('video-feed');
            const scanButton = document.getElementById('scan-button');
            const scanMessage = document.getElementById('scan-message');
            const loadingSpinner = document.getElementById('loading-spinner');
            const scannedList = document.getElementById('scanned-list');
            const exportButton = document.getElementById('export-button');
            const modal = document.getElementById('message-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalCloseButton = document.getElementById('modal-close-button');

            // --- State Variables ---
            let codeReader = null;
            let videoStream = null;
            let isScanning = false;
            let scanMode = 'qr';
            let scannedQrData = null;
            let scannedItems = [];

            // --- Utility Functions ---
            const showModal = (title, message) => {
                modalTitle.textContent = title;
                modalBody.textContent = message;
                modal.classList.remove('hidden');
            };

            const hideModal = () => {
                modal.classList.add('hidden');
            };

            const updateStatusMessage = (message, showSpinner = false) => {
                scanMessage.textContent = message;
                loadingSpinner.classList.toggle('hidden', !showSpinner);
            };

            const updateScannedList = () => {
                scannedList.innerHTML = '';
                if (scannedItems.length === 0) {
                    scannedList.innerHTML = '<li class="text-gray-500 dark:text-gray-400">No items scanned yet.</li>';
                    return;
                }
                scannedItems.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.classList.add('p-4', 'bg-white', 'dark:bg-gray-800', 'rounded-lg', 'shadow-md', 'flex', 'flex-col', 'md:flex-row', 'md:items-center', 'justify-between', 'space-y-2', 'md:space-y-0');
                    li.innerHTML = `
                        <div class="flex-1 min-w-0">
                            <span class="font-semibold text-blue-600 dark:text-blue-400">Item ${index + 1}:</span>
                            <div class="flex flex-col md:flex-row md:space-x-4 text-sm mt-1">
                                <span class="truncate">QR Code: <span class="font-medium text-gray-700 dark:text-gray-200">${item.qrCode}</span></span>
                                <span class="truncate">Barcode: <span class="font-medium text-gray-700 dark:text-gray-200">${item.code128}</span></span>
                            </div>
                        </div>
                        <button class="delete-btn px-3 py-1 bg-red-500 text-white rounded-full hover:bg-red-600 transition duration-300 transform hover:scale-105" data-index="${index}">Delete</button>
                    `;
                    scannedList.appendChild(li);
                });
            };

            const saveScannedItem = (qrData, code128Data) => {
                scannedItems.push({
                    qrCode: qrData,
                    code128: code128Data,
                    timestamp: new Date().toISOString()
                });
                updateScannedList();
            };

            const exportToExcel = () => {
                if (scannedItems.length === 0) {
                    showModal("Export Failed", "There is no data to export. Scan some items first.");
                    return;
                }

                const dataToExport = scannedItems.map(item => ({
                    'QR Code Data': item.qrCode,
                    'Code 128 Number': item.code128,
                    'Timestamp': new Date(item.timestamp).toLocaleString()
                }));

                const ws = XLSX.utils.json_to_sheet(dataToExport);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Scanned Data");

                XLSX.writeFile(wb, "scanned_data.xlsx");
                showModal("Export Complete", "Your data has been successfully exported to 'scanned_data.xlsx'.");
            };
            
            // --- Scanner Control Functions ---
            const startScanning = async () => {
                if (isScanning) return;
                isScanning = true;
                scanButton.textContent = 'Stop Scanning';
                scanButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                scanButton.classList.add('bg-red-600', 'hover:bg-red-700');
                updateStatusMessage("Requesting camera access...", true);
                scanMode = 'qr';
                scannedQrData = null;

                if (codeReader) {
                    codeReader.reset();
                }

                codeReader = new window.ZXing.BrowserMultiFormatReader();

                try {
                    videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    videoElement.srcObject = videoStream;
                    
                    // Wait for the video to be ready before decoding
                    videoElement.addEventListener('loadedmetadata', () => {
                        updateStatusMessage("Scanner is active. Ready to scan!", false);

                        codeReader.decodeFromStream(videoStream, videoElement, (result, err) => {
                            if (result) {
                                handleScanResult(result.getText(), result.getBarcodeFormat().getName());
                            }
                        });
                    }, { once: true });

                    videoElement.play();
                    
                } catch (err) {
                    console.error("Error accessing camera:", err);
                    updateStatusMessage("Error: Camera access denied. Please enable camera permissions and try again.");
                    showModal("Camera Error", "Could not access the camera. Please check your browser permissions or try reloading the page.");
                    stopScanning();
                }
            };

            const stopScanning = () => {
                if (!isScanning) return;
                isScanning = false;
                scanButton.textContent = 'Start Scanning';
                scanButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                scanButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                updateStatusMessage("Scanner stopped.");
                
                if (codeReader) {
                    codeReader.reset();
                    codeReader = null;
                }
                
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                    videoStream = null;
                    videoElement.srcObject = null;
                }
            };

            const handleScanResult = (result, format) => {
                console.log(`Scanned format: ${format}, result: ${result}`);

                if (scanMode === 'qr' && format === 'QR_CODE') {
                    scannedQrData = result;
                    updateStatusMessage("QR code found! Now scan the Code 128 barcode.", false);
                    scanMode = 'code128';
                } else if (scanMode === 'code128' && format === 'CODE_128') {
                    if (scannedQrData) {
                        saveScannedItem(scannedQrData, result);
                        updateStatusMessage("Item saved! Scan the next QR code.", false);
                        scannedQrData = null;
                        scanMode = 'qr';
                    } else {
                        updateStatusMessage("QR code not scanned yet. Please scan the QR code first.", false);
                    }
                }
            };

            const setupEventListeners = () => {
                scanButton.addEventListener('click', () => {
                    if (isScanning) {
                        stopScanning();
                    } else {
                        startScanning();
                    }
                });

                exportButton.addEventListener('click', exportToExcel);
                modalCloseButton.addEventListener('click', hideModal);

                document.addEventListener('click', (event) => {
                    if (event.target.classList.contains('delete-btn')) {
                        const index = parseInt(event.target.dataset.index);
                        if (!isNaN(index)) {
                            scannedItems.splice(index, 1);
                            updateScannedList();
                        }
                    }
                });
            };

            // Main initialization flow
            updateStatusMessage("App ready. Press 'Start Scanning' to begin.");
            scanButton.disabled = false;
            exportButton.disabled = false;
            scanButton.classList.remove('opacity-50', 'cursor-not-allowed');
            exportButton.classList.remove('opacity-50', 'cursor-not-allowed');
            loadingSpinner.classList.add('hidden');
            setupEventListeners();
        });
    </script>
</body>
</html>
